pipeline {
    agent any
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    if (isUnix()) {
                        sh 'git https://github.com/dhineshkumarmech/PipelineDemoProject.git'
                    } else {
                        bat 'git https://github.com/dhineshkumarmech/PipelineDemoProject.git'
                    }
                }
            }
        }

        stage('Build') {
            steps {
                script {
                    def mvnCmd = isUnix() ? 'MAVEN_HOME' : 'MAVEN_HOME.cmd'
                    sh "${mvnCmd} clean package"
                }
            }
        }

        stage('Deploy to Tomcat') {
            steps {
                script {
                    def tomcatUrl = 'http://localhost:6060/'
                    def tomcatCredentialsId = '42cfc17f-f00a-4771-866b-388b32e69a4c'
                    def warFile = findFiles(glob: '**/target/*.war')[0]

                    withCredentials([usernamePassword(credentialsId: tomcatCredentialsId, usernameVariable: 'TOMCAT_USER', passwordVariable: 'TOMCAT_PASSWORD')]) {
                        // Adjust the curl command for Windows or Unix
                        def curlCmd = isUnix() ? "curl" : "curl.exe"
                        sh "${curlCmd} -u $TOMCAT_USER:$TOMCAT_PASSWORD --upload-file $warFile ${tomcatUrl}/manager/text/deploy?path=/webapp"
                    }
                }
            }
        }
    }
}
